# æ–‡æ¡£æ•°æ®åº“ä¸å€’æ’ç´¢å¼•

## ä¸€ã€MongoDBæ–‡æ¡£å‹æ•°æ®åº“æ ¸å¿ƒ

### 1.1 æ ¸å¿ƒæ¦‚å¿µï¼ˆä¸å…³ç³»å‹æ•°æ®åº“å¯¹æ¯”ï¼‰
MongoDBæ˜¯ä¸€ç§åŸºäº**BSONï¼ˆäºŒè¿›åˆ¶JSONï¼‰**çš„æ–‡æ¡£å‹NoSQLæ•°æ®åº“ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯â€œæ— å›ºå®šSchemaã€æ˜“æ‰©å±•ã€é¢å‘æ–‡æ¡£â€ï¼Œç‰¹åˆ«é€‚åˆå­˜å‚¨éç»“æ„åŒ–æˆ–åŠç»“æ„åŒ–æ•°æ®ã€‚

| MongoDBæ¦‚å¿µ | å…³ç³»å‹æ•°æ®åº“ï¼ˆMySQLï¼‰ | æ ¸å¿ƒè¯´æ˜ |
|------------|-------------------|----------|
| æ•°æ®åº“ï¼ˆDBï¼‰ | æ•°æ®åº“ | é€»è¾‘éš”ç¦»çš„æ•°æ®é›†ï¼Œå¦‚`ecommerce`å­˜å‚¨ç”µå•†æ•°æ® |
| é›†åˆï¼ˆCollectionï¼‰ | è¡¨ | å­˜å‚¨æ–‡æ¡£çš„å®¹å™¨ï¼Œæ— éœ€é¢„å®šä¹‰å­—æ®µç»“æ„ |
| æ–‡æ¡£ï¼ˆDocumentï¼‰ | è¡Œ | åŸºæœ¬æ•°æ®å•å…ƒï¼ŒBSONæ ¼å¼ï¼Œæ”¯æŒåµŒå¥—å’Œæ•°ç»„ |
| å­—æ®µï¼ˆFieldï¼‰ | åˆ— | æ–‡æ¡£å±æ€§ï¼Œå¯åŠ¨æ€å¢åˆ  |
| _idå­—æ®µ | ä¸»é”® | é»˜è®¤å”¯ä¸€æ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰æˆ–è‡ªåŠ¨ç”ŸæˆObjectId |

### 1.2 æ ¸å¿ƒç‰¹æ€§

#### ğŸ”¸ Schemaçµæ´»æ€§
- é›†åˆæ— éœ€é¢„å®šä¹‰å­—æ®µç±»å‹å’Œæ•°é‡
- ä¸åŒæ–‡æ¡£å¯æ‹¥æœ‰å®Œå…¨ä¸åŒçš„å­—æ®µç»“æ„
- æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ·»åŠ æˆ–åˆ é™¤å­—æ®µ

#### ğŸ”¸ ä¸°å¯Œçš„æ•°æ®ç±»å‹
- åŸºæœ¬ç±»å‹ï¼šStringã€Numberã€Booleanã€Null
- å¤æ‚ç±»å‹ï¼šArrayã€Objectï¼ˆåµŒå¥—æ–‡æ¡£ï¼‰
- ç‰¹æ®Šç±»å‹ï¼šObjectIdã€Dateã€Timestampã€Binary Data
- åœ°ç†ç©ºé—´ï¼šGeoJSON Pointã€LineStringã€Polygon
- å…¶ä»–ï¼šRegular Expressionã€JavaScript Code

#### ğŸ”¸ é«˜å¯ç”¨æ¶æ„
- **å‰¯æœ¬é›†ï¼ˆReplica Setï¼‰**ï¼š1ä¸»Nä»æ¶æ„ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»
  - ä¸»èŠ‚ç‚¹å¤„ç†æ‰€æœ‰å†™æ“ä½œ
  - ä»èŠ‚ç‚¹å¼‚æ­¥å¤åˆ¶æ•°æ®ï¼Œå¯å¤„ç†è¯»è¯·æ±‚
  - è‡ªåŠ¨é€‰ä¸¾æœºåˆ¶ä¿è¯é«˜å¯ç”¨æ€§
  
- **åˆ†ç‰‡é›†ç¾¤ï¼ˆShardingï¼‰**ï¼šæ°´å¹³æ‰©å±•è§£å†³æ–¹æ¡ˆ
  - æ•°æ®æŒ‰åˆ†ç‰‡é”®åˆ†å¸ƒåˆ°å¤šä¸ªèŠ‚ç‚¹
  - æ”¯æŒèŒƒå›´åˆ†ç‰‡å’Œå“ˆå¸Œåˆ†ç‰‡ç­–ç•¥
  - æŸ¥è¯¢è·¯ç”±å™¨ï¼ˆmongosï¼‰è‡ªåŠ¨è·¯ç”±è¯·æ±‚

### 1.3 å¸¸ç”¨CRUDæ“ä½œ

```javascript
// ========== æ’å…¥æ“ä½œ ==========
// å•æ¡æ’å…¥
db.users.insertOne({
    name: "æå››", 
    age: 30, 
    address: {
        province: "åŒ—äº¬", 
        city: "æœé˜³"
    }
});

// æ‰¹é‡æ’å…¥
db.users.insertMany([
    {name: "ç‹äº”", age: 28},
    {name: "èµµå…­", age: 35}
]);

// ========== æŸ¥è¯¢æ“ä½œ ==========
// æ¡ä»¶æŸ¥è¯¢
db.users.find({age: {$gt: 28}}); // å¹´é¾„>28

// æŠ•å½±æŸ¥è¯¢ï¼ˆåªè¿”å›æŒ‡å®šå­—æ®µï¼‰
db.users.find({}, {name: 1, age: 1, _id: 0});

// åµŒå¥—æ–‡æ¡£æŸ¥è¯¢
db.users.find({"address.province": "åŒ—äº¬"});

// æ•°ç»„æŸ¥è¯¢
db.users.find({hobbies: "ç¯®çƒ"}); // æ•°ç»„åŒ…å«"ç¯®çƒ"
db.users.find({hobbies: {$all: ["ç¯®çƒ", "æ¸¸æ³³"]}}); // åŒ…å«æ‰€æœ‰å…ƒç´ 
db.users.find({hobbies: {$size: 3}}); // æ•°ç»„é•¿åº¦ä¸º3

// æ’åºå’Œåˆ†é¡µ
db.users.find()
    .sort({age: -1})    // é™åºæ’åº
    .limit(10)          // é™åˆ¶10æ¡
    .skip(20);          // è·³è¿‡å‰20æ¡

// ========== æ›´æ–°æ“ä½œ ==========
// å•æ¡æ›´æ–°
db.users.updateOne(
    {name: "æå››"}, 
    {$set: {age: 31}}
);

// æ‰¹é‡æ›´æ–°
db.users.updateMany(
    {age: {$lt: 30}}, 
    {$inc: {age: 1}}    // å¹´é¾„åŠ 1
);

// æ•°ç»„æ“ä½œ
db.users.updateOne(
    {name: "ç‹äº”"},
    {$push: {hobbies: "é˜…è¯»"}}  // æ·»åŠ æ•°ç»„å…ƒç´ 
);

// ========== åˆ é™¤æ“ä½œ ==========
db.users.deleteOne({name: "èµµå…­"});      // å•æ¡åˆ é™¤
db.users.deleteMany({age: {$gt: 35}});   // æ‰¹é‡åˆ é™¤
```

### 1.4 ç´¢å¼•æœ€ä½³å®è·µ

#### ğŸ“Š ç´¢å¼•ç±»å‹
1. **å•å­—æ®µç´¢å¼•**ï¼šæœ€å¸¸ç”¨ï¼Œé€‚åˆé«˜é¢‘æŸ¥è¯¢å­—æ®µ
   ```javascript
   db.users.createIndex({user_id: 1});  // å‡åºç´¢å¼•
   ```

2. **å¤åˆç´¢å¼•**ï¼šå¤šå­—æ®µç»„åˆæŸ¥è¯¢
   ```javascript
   // ç­‰å€¼å­—æ®µåœ¨å‰ï¼ŒèŒƒå›´å­—æ®µåœ¨å
   db.users.createIndex({province: 1, age: -1});
   ```

3. **å¤šé”®ç´¢å¼•**ï¼šæ•°ç»„å­—æ®µç´¢å¼•
   ```javascript
   db.users.createIndex({hobbies: 1});
   ```

4. **æ–‡æœ¬ç´¢å¼•**ï¼šå…¨æ–‡æœç´¢ï¼ˆåŠŸèƒ½æœ‰é™ï¼‰
   ```javascript
   db.articles.createIndex({content: "text"});
   ```

5. **åœ°ç†ç©ºé—´ç´¢å¼•**ï¼šä½ç½®æŸ¥è¯¢
   ```javascript
   db.places.createIndex({location: "2dsphere"});
   ```

#### âš ï¸ ç´¢å¼•æ³¨æ„äº‹é¡¹
- **ç´¢å¼•é¡ºåºåŸåˆ™**ï¼šç­‰å€¼æŸ¥è¯¢å­—æ®µåœ¨å‰ï¼ŒèŒƒå›´æŸ¥è¯¢å­—æ®µåœ¨å
- **ç´¢å¼•è¦†ç›–æŸ¥è¯¢**ï¼šå°½é‡è®©æŸ¥è¯¢åªä½¿ç”¨ç´¢å¼•ï¼Œé¿å…å›è¡¨
- **é¿å…è¿‡å¤šç´¢å¼•**ï¼šæ¯ä¸ªç´¢å¼•éƒ½ä¼šå¢åŠ å†™æ“ä½œå¼€é”€
- **ç›‘æ§ç´¢å¼•ä½¿ç”¨**ï¼šå®šæœŸä½¿ç”¨`$indexStats`åˆ†æç´¢å¼•æ•ˆç‡
- **ç´¢å¼•å¤§å°é™åˆ¶**ï¼šå•ä¸ªç´¢å¼•æ¡ç›®ä¸èƒ½è¶…è¿‡1024å­—èŠ‚

#### ğŸ” æŸ¥è¯¢æ€§èƒ½åˆ†æ
```javascript
// åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
db.users.find({age: 30})
    .explain("executionStats");

// æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
db.users.aggregate([{$indexStats: {}}]);
```

---

## äºŒã€Elasticsearchå€’æ’ç´¢å¼•æ ¸å¿ƒæŠ€æœ¯

### 2.1 ç´¢å¼•æœºåˆ¶å¯¹æ¯”

#### æ­£æ’ç´¢å¼• vs å€’æ’ç´¢å¼•

| ç‰¹æ€§ | æ­£æ’ç´¢å¼•ï¼ˆForward Indexï¼‰ | å€’æ’ç´¢å¼•ï¼ˆInverted Indexï¼‰ |
|------|-------------------------|--------------------------|
| ç»“æ„ | æ–‡æ¡£ID â†’ æ–‡æ¡£å†…å®¹å…³é”®è¯ | å…³é”®è¯ â†’ åŒ…å«è¯¥è¯çš„æ–‡æ¡£IDåˆ—è¡¨ |
| æŸ¥è¯¢æ–¹å¼ | å·²çŸ¥æ–‡æ¡£IDæŸ¥å†…å®¹ | å·²çŸ¥å…³é”®è¯æŸ¥æ–‡æ¡£ |
| ä¼˜ç‚¹ | ç®€å•ç›´è§‚ï¼Œæ›´æ–°æ–¹ä¾¿ | å…¨æ–‡æ£€ç´¢æå¿«ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢ |
| ç¼ºç‚¹ | å…¨æ–‡æ£€ç´¢æ€§èƒ½å·® | å†™å…¥å¼€é”€å¤§ï¼Œå­˜å‚¨ç©ºé—´è¾ƒå¤§ |

#### ğŸ“ ç¤ºä¾‹è¯´æ˜
å‡è®¾æœ‰ä»¥ä¸‹æ–‡æ¡£ï¼š
- æ–‡æ¡£1ï¼š`"Elasticsearch is a search engine"`
- æ–‡æ¡£2ï¼š`"MongoDB is a document database"`

**æ­£æ’ç´¢å¼•ç»“æ„ï¼š**
```
æ–‡æ¡£1 â†’ [Elasticsearch, search, engine]
æ–‡æ¡£2 â†’ [MongoDB, document, database]
```

**å€’æ’ç´¢å¼•ç»“æ„ï¼š**
```
Elasticsearch â†’ [æ–‡æ¡£1]
search â†’ [æ–‡æ¡£1]
engine â†’ [æ–‡æ¡£1]
MongoDB â†’ [æ–‡æ¡£2]
document â†’ [æ–‡æ¡£2]
database â†’ [æ–‡æ¡£2]
```

### 2.2 å€’æ’ç´¢å¼•æ ¸å¿ƒç»„æˆ

#### ğŸ”¤ è¯å…¸ï¼ˆTerm Dictionaryï¼‰
- å­˜å‚¨æ‰€æœ‰å»é‡åçš„å…³é”®è¯
- æŒ‰å­—æ¯é¡ºåºæ’åºï¼Œæ”¯æŒäºŒåˆ†æŸ¥æ‰¾
- å†…å­˜ä¸­å­˜å‚¨å‰ç¼€ç´¢å¼•ï¼ˆTerm Indexï¼‰ï¼ŒåŠ é€Ÿå®šä½

#### ğŸ“‹ å€’æ’åˆ—è¡¨ï¼ˆPosting Listï¼‰
æ¯ä¸ªå…³é”®è¯å¯¹åº”ä¸€ä¸ªå€’æ’åˆ—è¡¨ï¼ŒåŒ…å«ï¼š
1. **æ–‡æ¡£IDåˆ—è¡¨**ï¼šåŒ…å«è¯¥è¯çš„æ‰€æœ‰æ–‡æ¡£ID
2. **è¯é¢‘ï¼ˆTFï¼‰**ï¼šè¯¥è¯åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°
3. **ä½ç½®ï¼ˆPositionï¼‰**ï¼šè¯¥è¯åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®ä¿¡æ¯
4. **åç§»é‡ï¼ˆOffsetï¼‰**ï¼šè¯¥è¯åœ¨æ–‡æ¡£ä¸­çš„å­—ç¬¦èµ·æ­¢ä½ç½®
5. **å…¶ä»–å…ƒæ•°æ®**ï¼šå¦‚æ–‡æ¡£æƒé‡ã€å­—æ®µä¿¡æ¯ç­‰

### 2.3 å€’æ’ç´¢å¼•ä¼˜åŒ–æœºåˆ¶

#### ğŸ”§ ç´¢å¼•å‹ç¼©æŠ€æœ¯
1. **å¢é‡ç¼–ç ï¼ˆDelta Encodingï¼‰**
   ```
   åŸå§‹ID: [100, 101, 105, 110]
   å¢é‡ç¼–ç : [100, 1, 4, 5]
   ```

2. **å˜é•¿å­—èŠ‚ç¼–ç ï¼ˆVariable Byteï¼‰**
   - å°æ•°å€¼ç”¨è¾ƒå°‘å­—èŠ‚å­˜å‚¨
   - å¤§æ•°å€¼ç”¨è¾ƒå¤šå­—èŠ‚å­˜å‚¨

3. **å¸§å¯¹ä½å‹ç¼©ï¼ˆFrame Of Referenceï¼‰**
   - å°†æ–‡æ¡£IDåˆ†ç»„å‹ç¼©
   - æ¯ä¸ªç»„å†…ä½¿ç”¨ç›¸åŒä½å®½å­˜å‚¨

#### ğŸš€ æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
1. **è·³è¡¨ï¼ˆSkip Listï¼‰**ï¼šåœ¨å€’æ’åˆ—è¡¨ä¸­å»ºç«‹è·³è¡¨ï¼ŒåŠ é€ŸAND/ORæŸ¥è¯¢
2. **å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰**ï¼šå¿«é€Ÿåˆ¤æ–­å…³é”®è¯æ˜¯å¦å­˜åœ¨
3. **ç¼“å­˜æœºåˆ¶**ï¼š
   - Filter Cacheï¼šç¼“å­˜è¿‡æ»¤æŸ¥è¯¢ç»“æœ
   - Field Data Cacheï¼šç¼“å­˜å­—æ®µæ•°æ®ç”¨äºèšåˆ
   - Query Cacheï¼šç¼“å­˜æŸ¥è¯¢ç»“æœ

### 2.4 ç´¢å¼•æ›´æ–°æœºåˆ¶
ESé‡‡ç”¨**å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰**ç­–ç•¥å¤„ç†ç´¢å¼•æ›´æ–°ï¼š

```
æ›´æ–°æµç¨‹ï¼š
1. æ ‡è®°æ—§æ–‡æ¡£ä¸ºåˆ é™¤ï¼ˆ.delæ–‡ä»¶ï¼‰
2. åˆ›å»ºæ–°çš„å€’æ’ç´¢å¼•æ®µï¼ˆSegmentï¼‰
3. æŸ¥è¯¢æ—¶åˆå¹¶æ–°æ—§æ®µç»“æœ
4. å®šæœŸæ®µåˆå¹¶ï¼ˆSegment Mergeï¼‰
   - åˆå¹¶å¤šä¸ªå°æ®µä¸ºä¸€ä¸ªå¤§æ®µ
   - ç‰©ç†åˆ é™¤æ ‡è®°åˆ é™¤çš„æ–‡æ¡£
   - ä¼˜åŒ–ç´¢å¼•ç»“æ„
```

### 2.5 æ ¸å¿ƒåº”ç”¨åœºæ™¯

#### ğŸ” å…¨æ–‡æ£€ç´¢
```json
GET /articles/_search
{
  "query": {
    "match": {
      "content": "å…¨æ–‡æ£€ç´¢æŠ€æœ¯"
    }
  },
  "highlight": {
    "fields": {
      "content": {}
    }
  }
}
```

#### ğŸ“Š ç›¸å…³æ€§æ’åº
- **TF-IDFç®—æ³•**ï¼šè¯é¢‘ Ã— é€†æ–‡æ¡£é¢‘ç‡
- **BM25ç®—æ³•**ï¼šæ”¹è¿›çš„TF-IDFï¼ŒESé»˜è®¤ç®—æ³•
- **å‘é‡ç©ºé—´æ¨¡å‹**ï¼šæ–‡æ¡£ç›¸ä¼¼åº¦è®¡ç®—

#### ğŸ¯ è¯­ä¹‰æœç´¢ï¼ˆES 8.0+ï¼‰
```json
{
  "query": {
    "neural": {
      "embedding": {
        "query_text": "äººå·¥æ™ºèƒ½åº”ç”¨",
        "model_id": "my-text-embedding-model",
        "k": 100
      }
    }
  }
}
```

---

## ä¸‰ã€èšåˆæŸ¥è¯¢æ·±åº¦å¯¹æ¯”

### 3.1 MongoDBèšåˆç®¡é“

#### ğŸ¯ æ ¸å¿ƒèšåˆé˜¶æ®µ

| é˜¶æ®µ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|
| `$match` | æ–‡æ¡£è¿‡æ»¤ | `{$match: {age: {$gt: 18}}}` |
| `$group` | åˆ†ç»„ç»Ÿè®¡ | `{$group: {_id: "$city", count: {$sum: 1}}}` |
| `$sort` | ç»“æœæ’åº | `{$sort: {count: -1}}` |
| `$project` | å­—æ®µæŠ•å½± | `{$project: {city: "$_id", total: 1, _id: 0}}` |
| `$lookup` | é›†åˆå…³è” | ç±»ä¼¼SQL JOIN |
| `$unwind` | æ•°ç»„å±•å¼€ | `{$unwind: "$hobbies"}` |
| `$facet` | å¤šé¢èšåˆ | åŒæ—¶è¿›è¡Œå¤šä¸ªèšåˆåˆ†æ |

#### ğŸ“Š å¤æ‚èšåˆç¤ºä¾‹
```javascript
// ç»Ÿè®¡å„åŸå¸‚ä¸åŒå¹´é¾„æ®µç”¨æˆ·åˆ†å¸ƒ
db.users.aggregate([
  {
    $match: {
      register_date: {
        $gte: ISODate("2024-01-01"),
        $lt: ISODate("2025-01-01")
      }
    }
  },
  {
    $bucket: {
      groupBy: "$age",
      boundaries: [0, 18, 30, 50, 100],
      default: "other",
      output: {
        count: {$sum: 1},
        avg_score: {$avg: "$credit_score"},
        cities: {$push: "$city"}
      }
    }
  },
  {
    $project: {
      age_group: "$_id",
      user_count: "$count",
      average_credit: {$round: ["$avg_score", 2]},
      unique_cities: {$size: {$setUnion: ["$cities", []]}},
      _id: 0
    }
  },
  {$sort: {user_count: -1}},
  {$limit: 10}
]);
```

### 3.2 Elasticsearchèšåˆæ¡†æ¶

#### ğŸ¯ èšåˆç±»å‹ä½“ç³»

```mermaid
graph TB
    A[Elasticsearch Aggregations] --> B[æŒ‡æ ‡èšåˆ Metrics]
    A --> C[æ¡¶èšåˆ Buckets]
    A --> D[ç®¡é“èšåˆ Pipeline]
    
    B --> B1[å•å€¼æŒ‡æ ‡]
    B --> B2[å¤šå€¼æŒ‡æ ‡]
    
    B1 --> B1a[avg, sum, min, max]
    B1 --> B1b[cardinality åŸºæ•°ç»Ÿè®¡]
    B1 --> B1c[value_count è®¡æ•°]
    
    B2 --> B2a[stats ç»Ÿè®¡æ±‡æ€»]
    B2 --> B2b[percentiles ç™¾åˆ†ä½æ•°]
    B2 --> B2c[top_hits é¡¶éƒ¨åŒ¹é…]
    
    C --> C1[Terms è¯é¡¹]
    C --> C2[Range èŒƒå›´]
    C --> C3[Date Histogram æ—¥æœŸç›´æ–¹å›¾]
    C --> C4[Nested åµŒå¥—ç±»å‹]
    
    D --> D1[Derivative å¯¼æ•°]
    D --> D2[Cumulative Sum ç´¯è®¡å’Œ]
    D --> D3[Bucket Script æ¡¶è„šæœ¬]
```

#### ğŸ“ˆ å®Œæ•´èšåˆç¤ºä¾‹
```json
GET /sales/_search
{
  "size": 0,
  "query": {
    "range": {
      "sale_date": {
        "gte": "2024-01-01",
        "lte": "2024-12-31"
      }
    }
  },
  "aggs": {
    "monthly_sales": {
      "date_histogram": {
        "field": "sale_date",
        "calendar_interval": "month",
        "format": "yyyy-MM",
        "order": {"_key": "asc"}
      },
      "aggs": {
        "by_category": {
          "terms": {
            "field": "category.keyword",
            "size": 5
          },
          "aggs": {
            "total_amount": {
              "sum": {"field": "amount"}
            },
            "avg_price": {
              "avg": {"field": "unit_price"}
            },
            "top_products": {
              "top_hits": {
                "size": 3,
                "_source": ["product_name", "brand"],
                "sort": [{"amount": {"order": "desc"}}]
              }
            }
          }
        },
        "month_total": {
          "sum_bucket": {
            "buckets_path": "by_category>total_amount"
          }
        },
        "monthly_growth": {
          "derivative": {
            "buckets_path": "month_total"
          }
        }
      }
    },
    "overall_stats": {
      "stats": {"field": "amount"}
    }
  }
}
```

### 3.3 MongoDB vs Elasticsearchèšåˆå¯¹æ¯”

| ç‰¹æ€§ç»´åº¦ | MongoDB | Elasticsearch |
|---------|---------|---------------|
| **è®¾è®¡ç†å¿µ** | æ–‡æ¡£å¤„ç†ç®¡é“ | æ£€ç´¢ç»“æœåˆ†æ |
| **æ€§èƒ½ç‰¹ç‚¹** | å•æœºèšåˆå¿«ï¼Œé›†ç¾¤éœ€ä¼˜åŒ– | åˆ†å¸ƒå¼å¹¶è¡Œè®¡ç®—ï¼Œå¤§æ•°æ®é‡ä¼˜ |
| **æ—¶é—´èšåˆ** | æ”¯æŒä½†è¯­æ³•å¤æ‚ | `date_histogram`åŸç”Ÿæ”¯æŒ |
| **å…¨æ–‡æ£€ç´¢+èšåˆ** | æœ‰é™æ”¯æŒï¼ˆæ–‡æœ¬ç´¢å¼•ï¼‰ | åŸç”Ÿä¸€ä½“åŒ–æ”¯æŒ |
| **å…³è”æŸ¥è¯¢** | `$lookup`æ”¯æŒJOIN | nested/parent-childæœ‰é™æ”¯æŒ |
| **å®æ—¶æ€§** | å®æ—¶èšåˆ | è¿‘å®æ—¶ï¼ˆé»˜è®¤1ç§’å»¶è¿Ÿï¼‰ |
| **å†…å­˜ç®¡ç†** | 100MBå†…å­˜é™åˆ¶ï¼ˆå¯è°ƒæ•´ï¼‰ | ä½¿ç”¨JVMå †å†…å­˜ï¼Œéœ€ç²¾ç»†è°ƒä¼˜ |
| **å­¦ä¹ æ›²çº¿** | ç›¸å¯¹ç®€å• | æ¦‚å¿µå¤æ‚ï¼Œä½†åŠŸèƒ½å¼ºå¤§ |

### 3.4 åœºæ™¯åŒ–é€‰æ‹©æŒ‡å—

#### ğŸ›’ ç”µå•†ä¸šåŠ¡åœºæ™¯
```yaml
# å•†å“æœç´¢+ç­›é€‰+æ’åº â†’ Elasticsearch
- å…¨æ–‡æ£€ç´¢å•†å“æ ‡é¢˜/æè¿°
- å¤šç»´åº¦ç­›é€‰ï¼ˆå“ç‰Œã€ä»·æ ¼ã€åˆ†ç±»ï¼‰
- ç›¸å…³æ€§æ’åº + é”€é‡æ’åº
- æœç´¢è¯å»ºè®®ï¼ˆcompletion suggesterï¼‰

# è®¢å•åˆ†æç»Ÿè®¡ â†’ MongoDB
- ç”¨æˆ·è®¢å•å†å²æŸ¥è¯¢
- å¤æ‚çš„åˆ†ç»„ç»Ÿè®¡ï¼ˆæŒ‰åœ°åŒºã€æ—¶é—´ã€å•†å“ï¼‰
- å…³è”ç”¨æˆ·ä¿¡æ¯åˆ†æ
- å®æ—¶åº“å­˜ç®¡ç†
```

#### ğŸ“Š æ—¥å¿—åˆ†æåœºæ™¯
```yaml
# æ—¥å¿—æ£€ç´¢åˆ†æ â†’ Elasticsearch
- å…³é”®è¯å¿«é€Ÿæ£€ç´¢
- é”™è¯¯æ—¥å¿—èšç±»åˆ†æ
- æ—¶é—´åºåˆ—è¶‹åŠ¿åˆ†æ
- å®æ—¶ç›‘æ§ä»ªè¡¨æ¿

# æ—¥å¿—å½’æ¡£æŸ¥è¯¢ â†’ MongoDB
- ç»“æ„åŒ–æ—¥å¿—å­˜å‚¨
- é•¿æ—¶é—´èŒƒå›´ç»Ÿè®¡
- å¤æ‚å…³è”åˆ†æ
- å®¡è®¡æ—¥å¿—ç®¡ç†
```

---

## å››ã€æœ€ä½³å®è·µä¸è°ƒä¼˜æŒ‡å—

### 4.1 MongoDBæ€§èƒ½ä¼˜åŒ–

#### ğŸ”§ æŸ¥è¯¢ä¼˜åŒ–
1. **ä½¿ç”¨æŠ•å½±å‡å°‘è¿”å›æ•°æ®**
   ```javascript
   // ä¸å¥½
   db.users.find({age: {$gt: 18}});
   
   // å¥½ï¼šåªè¿”å›éœ€è¦çš„å­—æ®µ
   db.users.find({age: {$gt: 18}}, {name: 1, email: 1, _id: 0});
   ```

2. **åˆç†ä½¿ç”¨ç´¢å¼•æç¤º**
   ```javascript
   db.users.find({city: "åŒ—äº¬", age: {$gt: 30}})
       .hint({city: 1, age: 1});
   ```

3. **é¿å…å…¨é›†åˆæ‰«æ**
   ```javascript
   // ç›‘æ§æ…¢æŸ¥è¯¢
   db.setProfilingLevel(1, {slowms: 100});
   db.system.profile.find().sort({ts: -1}).limit(10);
   ```

#### ğŸ—„ï¸ å­˜å‚¨ä¼˜åŒ–
1. **æ–‡æ¡£è®¾è®¡åŸåˆ™**
   ```javascript
   // åèŒƒå¼åŒ–è®¾è®¡ï¼šå°†å…³è”æ•°æ®åµŒå…¥æ–‡æ¡£
   {
     _id: "order_001",
     user: {
       id: "user_123",
       name: "å¼ ä¸‰",
       email: "zhangsan@example.com"
     },
     items: [
       {product_id: "p1", name: "å•†å“A", price: 100},
       {product_id: "p2", name: "å•†å“B", price: 200}
     ]
   }
   ```

2. **é€‚æ—¶ä½¿ç”¨å¼•ç”¨**
   ```javascript
   // å½“å…³è”æ•°æ®é¢‘ç¹æ›´æ–°æˆ–è¿‡å¤§æ—¶ä½¿ç”¨å¼•ç”¨
   {
     _id: "order_001",
     user_id: "user_123",  // å¼•ç”¨ç”¨æˆ·é›†åˆ
     items: ["p1", "p2"]   // å¼•ç”¨å•†å“é›†åˆ
   }
   ```

### 4.2 Elasticsearchæ€§èƒ½è°ƒä¼˜

#### âš™ï¸ ç´¢å¼•è®¾è®¡ä¼˜åŒ–
1. **Mappingè®¾è®¡åŸåˆ™**
   ```json
   {
     "mappings": {
       "dynamic": "strict",  // ä¸¥æ ¼æ§åˆ¶å­—æ®µç±»å‹
       "properties": {
         "title": {
           "type": "text",
           "analyzer": "ik_max_word",  // ä¸­æ–‡åˆ†è¯
           "fields": {
             "keyword": {
               "type": "keyword",      // ç”¨äºèšåˆæ’åº
               "ignore_above": 256
             }
           }
         },
         "price": {
           "type": "scaled_float",    // èŠ‚çœå­˜å‚¨ç©ºé—´
           "scaling_factor": 100
         }
       }
     }
   }
   ```

2. **åˆ†ç‰‡ç­–ç•¥é…ç½®**
   ```yaml
   # åˆ†ç‰‡æ•° = æ•°æ®æ€»é‡ / å•ä¸ªåˆ†ç‰‡æ¨èå¤§å°(30-50GB)
   # å‰¯æœ¬æ•° = æ ¹æ®è¯»ååé‡å’Œå¯ç”¨æ€§è¦æ±‚è®¾ç½®(é€šå¸¸1-2)
   
   PUT /my_index
   {
     "settings": {
       "number_of_shards": 5,      # ä¸»åˆ†ç‰‡æ•°
       "number_of_replicas": 1,    # å‰¯æœ¬æ•°
       "refresh_interval": "30s"   # é™ä½åˆ·æ–°é¢‘ç‡æå‡å†™å…¥æ€§èƒ½
     }
   }
   ```

#### ğŸ” æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
1. **ä½¿ç”¨filterä¸Šä¸‹æ–‡**
   ```json
   {
     "query": {
       "bool": {
         "filter": [
           {"range": {"price": {"gte": 100, "lte": 1000}}},
           {"term": {"category": "electronics"}}
         ],
         "must": [
           {"match": {"description": "wireless bluetooth"}}
         ]
       }
     }
   }
   ```

2. **åˆ†é¡µä¼˜åŒ–**
   ```json
   // æ·±åº¦åˆ†é¡µä½¿ç”¨search_after
   {
     "size": 100,
     "sort": [
       {"_id": "asc"}
     ],
     "search_after": ["last_id_value"]
   }
   ```

### 4.3 æ··åˆæ¶æ„å®è·µ

#### ğŸ”„ æ•°æ®åŒæ­¥æ–¹æ¡ˆ
1. **å˜æ›´æ•°æ®æ•è·ï¼ˆCDCï¼‰**
   ```
   MongoDB â†’ MongoDB Connector â†’ Kafka â†’ Elasticsearch
   
   ä¼˜ç‚¹ï¼š
   - å®æ—¶æ•°æ®åŒæ­¥
   - è§£è€¦ç³»ç»Ÿä¾èµ–
   - æ”¯æŒæ•°æ®è½¬æ¢
   ```

2. **åŒå†™ç­–ç•¥**
   ```javascript
   // åº”ç”¨å±‚åŒæ—¶å†™å…¥ä¸¤ä¸ªæ•°æ®åº“
   async function createProduct(product) {
     // å†™å…¥MongoDBï¼ˆä¸»å­˜å‚¨ï¼‰
     const mongoResult = await mongoDb.products.insertOne(product);
     
     // å†™å…¥Elasticsearchï¼ˆæœç´¢ç´¢å¼•ï¼‰
     const esResult = await esClient.index({
       index: 'products',
       id: product.id,
       document: product
     });
     
     return {mongo: mongoResult, es: esResult};
   }
   ```

#### ğŸ“‹ æ•°æ®ä¸€è‡´æ€§ä¿éšœ
```javascript
class DualWriteManager {
  constructor(mongoClient, esClient) {
    this.mongoClient = mongoClient;
    this.esClient = esClient;
    this.compensationActions = new Map();
  }
  
  async dualWrite(operation, data) {
    const transactionId = uuidv4();
    
    try {
      // é˜¶æ®µ1ï¼šé¢„å†™å…¥
      await this.prepareWrite(transactionId, operation, data);
      
      // é˜¶æ®µ2ï¼šæ‰§è¡ŒMongoDBæ“ä½œ
      const mongoResult = await this.executeMongoOperation(operation, data);
      
      // é˜¶æ®µ3ï¼šæ‰§è¡ŒESæ“ä½œ
      const esResult = await this.executeESOperation(operation, data);
      
      // é˜¶æ®µ4ï¼šç¡®è®¤æäº¤
      await this.commitTransaction(transactionId);
      
      return {success: true, mongo: mongoResult, es: esResult};
      
    } catch (error) {
      // è¡¥å¿æ“ä½œ
      await this.compensate(transactionId);
      throw error;
    }
  }
}
```

---

## äº”ã€ç›‘æ§ä¸è¿ç»´

### 5.1 MongoDBç›‘æ§æŒ‡æ ‡

#### ğŸ“Š å…³é”®æ€§èƒ½æŒ‡æ ‡
```bash
# ä½¿ç”¨mongostatå®æ—¶ç›‘æ§
mongostat --host localhost:27017 --rowcount 10 1

# ä½¿ç”¨db.serverStatus()è·å–çŠ¶æ€
db.serverStatus().metrics

# é‡è¦æŒ‡æ ‡ï¼š
# - æ“ä½œè®¡æ•°å™¨ï¼ˆopcountersï¼‰
# - è¿æ¥æ•°ï¼ˆconnectionsï¼‰
# - å†…å­˜ä½¿ç”¨ï¼ˆmemï¼‰
# - ç½‘ç»œæµé‡ï¼ˆnetworkï¼‰
# - é”ç­‰å¾…æ—¶é—´ï¼ˆlocksï¼‰
```

#### ğŸ”” å‘Šè­¦é…ç½®
```yaml
# Prometheusç›‘æ§é…ç½®ç¤ºä¾‹
scrape_configs:
  - job_name: 'mongodb'
    static_configs:
      - targets: ['mongodb:9216']
    
# å…³é”®å‘Šè­¦è§„åˆ™ï¼š
# - è¿æ¥æ•°è¶…è¿‡80%
# - å¤åˆ¶å»¶è¿Ÿè¶…è¿‡10ç§’
# - CPUä½¿ç”¨ç‡æŒç»­é«˜äº70%
# - ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡85%
```

### 5.2 Elasticsearchç›‘æ§è¿ç»´

#### ğŸ“ˆ é›†ç¾¤å¥åº·æ£€æŸ¥
```json
GET /_cluster/health
{
  "cluster_name": "my-cluster",
  "status": "green",  # green, yellow, red
  "timed_out": false,
  "number_of_nodes": 3,
  "number_of_data_nodes": 2,
  "active_primary_shards": 10,
  "active_shards": 20,
  "relocating_shards": 0,
  "initializing_shards": 0,
  "unassigned_shards": 0,
  "delayed_unassigned_shards": 0,
  "number_of_pending_tasks": 0,
  "number_of_in_flight_fetch": 0,
  "task_max_waiting_in_queue_millis": 0,
  "active_shards_percent_as_number": 100.0
}
```

#### ğŸ› ï¸ è¿ç»´å‘½ä»¤
```bash
# æŸ¥çœ‹ç´¢å¼•çŠ¶æ€
GET /_cat/indices?v

# æŸ¥çœ‹åˆ†ç‰‡åˆ†é…
GET /_cat/shards?v

# æ¸…ç†ç¼“å­˜ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
POST /_cache/clear

# å¼ºåˆ¶æ®µåˆå¹¶ï¼ˆä¼˜åŒ–åªè¯»ç´¢å¼•ï¼‰
POST /my_index/_forcemerge?max_num_segments=1
```

---

## å…­ã€æ€»ç»“ä¸é€‰å‹å»ºè®®

### 6.1 æŠ€æœ¯é€‰å‹çŸ©é˜µ

| åœºæ™¯ç‰¹å¾ | æ¨èæ–¹æ¡ˆ | ç†ç”± |
|---------|---------|------|
| **Schemaé¢‘ç¹å˜åŒ–** | MongoDB | æ— æ¨¡å¼è®¾è®¡é€‚åº”å˜åŒ– |
| **å¤æ‚äº‹åŠ¡éœ€æ±‚** | MongoDBï¼ˆ4.0+æ”¯æŒäº‹åŠ¡ï¼‰ | æ–‡æ¡£çº§äº‹åŠ¡æ”¯æŒ |
| **å…¨æ–‡æ£€ç´¢ä¸ºä¸»** | Elasticsearch | å€’æ’ç´¢å¼•ä¸“ä¸šä¼˜åŒ– |
| **å®æ—¶æ•°æ®åˆ†æ** | Elasticsearch | è¿‘å®æ—¶æœç´¢åˆ†æ |
| **åœ°ç†ä½ç½®åº”ç”¨** | ä¸¤è€…å‡å¯ | MongoDBåœ°ç†ç´¢å¼•æ›´æˆç†Ÿ |
| **æ—¥å¿—å¤„ç†åˆ†æ** | Elasticsearch | ELKæ ˆç”Ÿæ€å®Œå–„ |
| **å†…å®¹ç®¡ç†ç³»ç»Ÿ** | MongoDB | åµŒå¥—æ–‡æ¡£é€‚åˆå†…å®¹æ¨¡å‹ |
| **å•†å“æœç´¢ç³»ç»Ÿ** | Elasticsearch | å¤šç»´åº¦ç­›é€‰æ’åºå¼ºå¤§ |

### 6.2 æ¶æ„æ¼”è¿›å»ºè®®

#### ğŸ—ï¸ åˆæœŸé˜¶æ®µï¼ˆå¿«é€ŸéªŒè¯ï¼‰
```yaml
æ¶æ„: MongoDBå•å®ä¾‹
ç†ç”±:
- å¼€å‘é€Ÿåº¦å¿«
- é™ä½è¿ç»´å¤æ‚åº¦
- é€‚åº”ä¸šåŠ¡å¿«é€Ÿå˜åŒ–
```

#### ğŸš€ æˆé•¿é˜¶æ®µï¼ˆä¸šåŠ¡æ‰©å±•ï¼‰
```yaml
æ¶æ„: MongoDBå‰¯æœ¬é›† + Elasticsearché›†ç¾¤
ç†ç”±:
- è¯»å†™åˆ†ç¦»æå‡æ€§èƒ½
- æœç´¢ä¸“ä¸šåŒ–
- é«˜å¯ç”¨ä¿éšœ
```

#### ğŸŒŸ æˆç†Ÿé˜¶æ®µï¼ˆå¤§è§„æ¨¡åº”ç”¨ï¼‰
```yaml
æ¶æ„: 
  - MongoDBåˆ†ç‰‡é›†ç¾¤ï¼ˆå¤„ç†æµ·é‡æ•°æ®ï¼‰
  - Elasticsearchå¤šé›†ç¾¤ï¼ˆéš”ç¦»ä¸åŒä¸šåŠ¡ï¼‰
  - æ•°æ®åŒæ­¥ç®¡é“ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
  - æ··åˆæŸ¥è¯¢å¼•æ“ï¼ˆç»Ÿä¸€æŸ¥è¯¢æ¥å£ï¼‰
```

### 6.3 æœªæ¥è¶‹åŠ¿

1. **èåˆè¶‹åŠ¿**ï¼šMongoDB Atlasæä¾›å…¨æ–‡æœç´¢åŠŸèƒ½ï¼ŒESå¢åŠ æ–‡æ¡£å­˜å‚¨èƒ½åŠ›
2. **AIé›†æˆ**ï¼šå‘é‡æœç´¢ã€è¯­ä¹‰ç†è§£ã€æ™ºèƒ½æ¨è
3. **äº‘åŸç”Ÿ**ï¼šServerlessæ•°æ®åº“æœåŠ¡ï¼Œè‡ªåŠ¨æ‰©ç¼©å®¹
4. **å¤šæ¨¡æ•°æ®åº“**ï¼šåŒæ—¶æ”¯æŒæ–‡æ¡£ã€å›¾ã€æ—¶åºç­‰å¤šç§æ•°æ®æ¨¡å‹

---

## ğŸ“š å­¦ä¹ èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [MongoDBå®˜æ–¹æ–‡æ¡£](https://docs.mongodb.com/)
- [Elasticsearchå®˜æ–¹æŒ‡å—](https://www.elastic.co/guide/index.html)





